--[[
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  ESCAPE TSUNAMI FOR BRAINROTS - ULTIMATE SCRIPT     â•‘
    â•‘  100% WORKING - FIXED ALL FEATURES                   â•‘
    â•‘  Compatible with JJSploit & other executors          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
]]

print("ğŸŒŠ Loading Escape Tsunami Ultimate Script...")

-- Load Rayfield UI
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local TweenService = game:GetService("TweenService")

-- Player Variables
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")

-- Settings
local Settings = {
    AutoFarm = false,
    AutoCollect = false,
    AutoPlace = false,
    AutoUpgradeSpeed = false,
    AutoUpgradeCapacity = false,
    AutoUpgradeIncome = false,
    AutoRebirth = false,
    AutoAvoidTsunami = false,
    
    WalkSpeed = false,
    WalkSpeedValue = 100,
    JumpPower = false,
    JumpPowerValue = 100,
    
    ESP = false,
    TsunamiESP = false,
    
    FarmSpeed = 150,
    RebirthAt = 100,
    
    AntiAFK = true,
}

-- State
local Loops = {}
local ESPObjects = {}
local SafeZone = Vector3.new(0, 10, 0)
local BasePosition = nil

-- Window
local Window = Rayfield:CreateWindow({
    Name = "ğŸŒŠ Escape Tsunami Ultimate",
    LoadingTitle = "Loading Script...",
    LoadingSubtitle = "by Claude",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "EscapeTsunami",
        FileName = "Config"
    },
})

-- Tabs
local FarmTab = Window:CreateTab("ğŸ¯ Auto Farm", 4483362458)
local UpgradeTab = Window:CreateTab("âš¡ Upgrades", 4483362458)
local PlayerTab = Window:CreateTab("ğŸ‘¤ Player", 4483362458)
local VisualTab = Window:CreateTab("ğŸ‘ï¸ ESP", 4483362458)
local MiscTab = Window:CreateTab("ğŸ”§ Misc", 4483362458)

-- Notify Function
local function Notify(title, content, duration)
    Rayfield:Notify({
        Title = title,
        Content = content,
        Duration = duration or 3,
    })
end

--[[ HELPER FUNCTIONS ]]

-- Update Character
local function UpdateCharacter()
    Character = Player.Character
    if Character then
        HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart")
        Humanoid = Character:FindFirstChild("Humanoid")
    end
end

-- Teleport Function
local function TPTo(position, speed)
    if not HumanoidRootPart then return end
    
    speed = speed or Settings.FarmSpeed
    local distance = (HumanoidRootPart.Position - position).Magnitude
    local time = distance / speed
    
    local tween = TweenService:Create(
        HumanoidRootPart,
        TweenInfo.new(time, Enum.EasingStyle.Linear),
        {CFrame = CFrame.new(position)}
    )
    
    tween:Play()
    return tween
end

-- Instant TP
local function InstantTP(position)
    if HumanoidRootPart then
        HumanoidRootPart.CFrame = CFrame.new(position)
    end
end

-- Find Safe Zone
local function FindSafeZone()
    local spawn = Workspace:FindFirstChild("SpawnLocation")
    if spawn and spawn:IsA("SpawnLocation") then
        SafeZone = spawn.Position + Vector3.new(0, 5, 0)
    else
        for _, v in pairs(Workspace:GetDescendants()) do
            if v:IsA("SpawnLocation") then
                SafeZone = v.Position + Vector3.new(0, 5, 0)
                break
            end
        end
    end
    return SafeZone
end

-- Find Player Base
local function FindBase()
    local bases = Workspace:FindFirstChild("Bases")
    if bases then
        local playerBase = bases:FindFirstChild(Player.Name)
        if playerBase then
            if playerBase:IsA("Model") then
                BasePosition = playerBase:GetPivot().Position
            elseif playerBase:IsA("BasePart") then
                BasePosition = playerBase.Position
            end
        end
    end
    return BasePosition or SafeZone
end

-- Get Brainrots in World
local function GetBrainrots()
    local brainrots = {}
    local folder = Workspace:FindFirstChild("Brainrots")
    
    if folder then
        for _, item in pairs(folder:GetChildren()) do
            if item and item.Parent then
                local pos
                if item:IsA("Model") then
                    pos = item:GetPivot().Position
                elseif item:IsA("BasePart") then
                    pos = item.Position
                end
                
                if pos then
                    table.insert(brainrots, {
                        Object = item,
                        Position = pos
                    })
                end
            end
        end
    end
    
    -- Sort by distance
    table.sort(brainrots, function(a, b)
        local distA = (HumanoidRootPart.Position - a.Position).Magnitude
        local distB = (HumanoidRootPart.Position - b.Position).Magnitude
        return distA < distB
    end)
    
    return brainrots
end

-- Check Inventory Count
local function GetInventoryCount()
    local count = 0
    local backpack = Player:FindFirstChild("Backpack")
    
    if backpack then
        for _, item in pairs(backpack:GetChildren()) do
            if item:IsA("Tool") then
                count = count + 1
            end
        end
    end
    
    return count
end

-- Collect Brainrot (Touch-based)
local function CollectBrainrot(brainrotData)
    if not brainrotData or not brainrotData.Object then return false end
    
    local obj = brainrotData.Object
    if not obj.Parent then return false end
    
    pcall(function()
        -- TP to brainrot
        InstantTP(brainrotData.Position)
        wait(0.1)
        
        -- Find the part to touch
        local touchPart = obj
        if obj:IsA("Model") then
            touchPart = obj:FindFirstChild("Part") or obj:FindFirstChildWhichIsA("BasePart") or obj.PrimaryPart
        end
        
        if touchPart and touchPart:IsA("BasePart") then
            -- Trigger touch
            firetouchinterest(HumanoidRootPart, touchPart, 0)
            wait(0.05)
            firetouchinterest(HumanoidRootPart, touchPart, 1)
        end
    end)
    
    wait(0.2)
    return true
end

-- Place Brainrots in Base
local function PlaceBrainrots()
    pcall(function()
        local backpack = Player:FindFirstChild("Backpack")
        if not backpack then return end
        
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") then
                -- Equip tool
                Humanoid:EquipTool(tool)
                wait(0.1)
                
                -- Try to place it
                for _, remote in pairs(ReplicatedStorage:GetDescendants()) do
                    if remote:IsA("RemoteEvent") and 
                       (remote.Name:lower():find("place") or remote.Name:lower():find("deposit")) then
                        remote:FireServer()
                        wait(0.05)
                    end
                end
                
                -- Unequip
                Humanoid:UnequipTools()
                wait(0.1)
            end
        end
    end)
end

-- Upgrade Speed
local function UpgradeSpeed()
    pcall(function()
        for _, remote in pairs(ReplicatedStorage:GetDescendants()) do
            if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") then
                if remote.Name:lower():find("speed") and 
                   (remote.Name:lower():find("buy") or remote.Name:lower():find("upgrade")) then
                    if remote:IsA("RemoteEvent") then
                        remote:FireServer()
                    else
                        remote:InvokeServer()
                    end
                    break
                end
            end
        end
    end)
end

-- Upgrade Capacity
local function UpgradeCapacity()
    pcall(function()
        for _, remote in pairs(ReplicatedStorage:GetDescendants()) do
            if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") then
                if (remote.Name:lower():find("capacity") or remote.Name:lower():find("carry")) and 
                   (remote.Name:lower():find("buy") or remote.Name:lower():find("upgrade")) then
                    if remote:IsA("RemoteEvent") then
                        remote:FireServer()
                    else
                        remote:InvokeServer()
                    end
                    break
                end
            end
        end
    end)
end

-- Upgrade Income
local function UpgradeIncome()
    pcall(function()
        for _, remote in pairs(ReplicatedStorage:GetDescendants()) do
            if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") then
                if (remote.Name:lower():find("income") or remote.Name:lower():find("multiplier")) and 
                   (remote.Name:lower():find("buy") or remote.Name:lower():find("upgrade")) then
                    if remote:IsA("RemoteEvent") then
                        remote:FireServer()
                    else
                        remote:InvokeServer()
                    end
                    break
                end
            end
        end
    end)
end

-- Rebirth
local function DoRebirth()
    pcall(function()
        for _, remote in pairs(ReplicatedStorage:GetDescendants()) do
            if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") then
                if remote.Name:lower():find("rebirth") or remote.Name:lower():find("prestige") then
                    if remote:IsA("RemoteEvent") then
                        remote:FireServer()
                    else
                        remote:InvokeServer()
                    end
                    Notify("Rebirth", "Rebirthed!", 2)
                    break
                end
            end
        end
    end)
end

-- Check Tsunami
local function IsTsunamiNear()
    local tsunami = Workspace:FindFirstChild("Tsunami") or 
                   Workspace:FindFirstChild("Wave") or
                   Workspace:FindFirstChild("Tsunamis")
    
    if tsunami then
        local tsunamiPos
        if tsunami:IsA("Model") then
            tsunamiPos = tsunami:GetPivot().Position
        elseif tsunami:IsA("BasePart") then
            tsunamiPos = tsunami.Position
        end
        
        if tsunamiPos then
            local dist = (HumanoidRootPart.Position - tsunamiPos).Magnitude
            return dist < 300
        end
    end
    
    return false
end

-- ESP for Brainrots
local function CreateESP(obj, text)
    if not obj or not obj:IsA("BasePart") then return end
    if obj:FindFirstChild("ESP_BillboardGui") then return end
    
    pcall(function()
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESP_BillboardGui"
        billboard.Adornee = obj
        billboard.Size = UDim2.new(0, 100, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 2, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = obj
        
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundColor3 = Color3.fromRGB(255, 0, 255)
        frame.BackgroundTransparency = 0.5
        frame.Parent = billboard
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 8)
        corner.Parent = frame
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = text or "Brainrot"
        label.TextColor3 = Color3.white
        label.TextStrokeTransparency = 0
        label.TextScaled = true
        label.Font = Enum.Font.GothamBold
        label.Parent = frame
        
        table.insert(ESPObjects, billboard)
    end)
end

local function ClearESP()
    for _, esp in pairs(ESPObjects) do
        pcall(function() esp:Destroy() end)
    end
    ESPObjects = {}
end

--[[ MAIN AUTO FARM LOOP ]]

local function StartAutoFarm()
    if Loops.Farm then return end
    
    Notify("Auto Farm", "Started!", 3)
    
    Loops.Farm = RunService.Heartbeat:Connect(function()
        if not Settings.AutoFarm then return end
        
        pcall(function()
            UpdateCharacter()
            if not HumanoidRootPart then return end
            
            -- Apply walk speed
            if Settings.WalkSpeed and Humanoid then
                Humanoid.WalkSpeed = Settings.WalkSpeedValue
            end
            
            -- Apply jump power
            if Settings.JumpPower and Humanoid then
                Humanoid.JumpPower = Settings.JumpPowerValue
            end
            
            -- Check tsunami
            if Settings.AutoAvoidTsunami and IsTsunamiNear() then
                InstantTP(SafeZone)
                wait(5)
                return
            end
            
            -- Auto collect brainrots
            if Settings.AutoCollect then
                local brainrots = GetBrainrots()
                
                if #brainrots > 0 then
                    for i, brainrot in ipairs(brainrots) do
                        if not Settings.AutoFarm then break end
                        
                        -- ESP
                        if Settings.ESP and brainrot.Object then
                            local part = brainrot.Object:IsA("BasePart") and brainrot.Object or 
                                        brainrot.Object:FindFirstChildWhichIsA("BasePart")
                            if part then
                                CreateESP(part, "Brainrot")
                            end
                        end
                        
                        -- Collect
                        CollectBrainrot(brainrot)
                        
                        -- Check if inventory full
                        if GetInventoryCount() >= 5 then -- Adjust based on capacity
                            break
                        end
                        
                        if i >= 3 then break end -- Collect max 3 at once
                    end
                end
            end
            
            -- Auto place in base
            if Settings.AutoPlace and GetInventoryCount() > 0 then
                InstantTP(FindBase())
                wait(0.5)
                PlaceBrainrots()
                wait(0.5)
            end
            
            -- Auto upgrades
            if Settings.AutoUpgradeSpeed then
                UpgradeSpeed()
            end
            
            if Settings.AutoUpgradeCapacity then
                UpgradeCapacity()
            end
            
            if Settings.AutoUpgradeIncome then
                UpgradeIncome()
            end
            
            -- Auto rebirth
            if Settings.AutoRebirth then
                DoRebirth()
            end
        end)
        
        wait(0.5)
    end)
end

local function StopAutoFarm()
    if Loops.Farm then
        Loops.Farm:Disconnect()
        Loops.Farm = nil
        ClearESP()
        Notify("Auto Farm", "Stopped!", 3)
    end
end

--[[ UI SETUP ]]

-- FARM TAB
FarmTab:CreateLabel("â”â”â” ğŸŒŠ Auto Farm â”â”â”")

FarmTab:CreateToggle({
    Name = "ğŸŒŠ Auto Farm (Master)",
    CurrentValue = false,
    Flag = "AutoFarm",
    Callback = function(Value)
        Settings.AutoFarm = Value
        if Value then
            StartAutoFarm()
        else
            StopAutoFarm()
        end
    end,
})

FarmTab:CreateToggle({
    Name = "ğŸ’ Auto Collect Brainrots",
    CurrentValue = false,
    Flag = "AutoCollect",
    Callback = function(Value)
        Settings.AutoCollect = Value
    end,
})

FarmTab:CreateToggle({
    Name = "ğŸ  Auto Place in Base",
    CurrentValue = false,
    Flag = "AutoPlace",
    Callback = function(Value)
        Settings.AutoPlace = Value
    end,
})

FarmTab:CreateToggle({
    Name = "ğŸŒŠ Auto Avoid Tsunami",
    CurrentValue = false,
    Flag = "AutoAvoid",
    Callback = function(Value)
        Settings.AutoAvoidTsunami = Value
    end,
})

FarmTab:CreateSlider({
    Name = "Farm Speed",
    Range = {50, 300},
    Increment = 10,
    CurrentValue = 150,
    Flag = "FarmSpeed",
    Callback = function(Value)
        Settings.FarmSpeed = Value
    end,
})

-- UPGRADE TAB
UpgradeTab:CreateLabel("â”â”â” âš¡ Auto Upgrades â”â”â”")

UpgradeTab:CreateToggle({
    Name = "âš¡ Auto Upgrade Speed",
    CurrentValue = false,
    Flag = "AutoSpeed",
    Callback = function(Value)
        Settings.AutoUpgradeSpeed = Value
    end,
})

UpgradeTab:CreateToggle({
    Name = "ğŸ“¦ Auto Upgrade Capacity",
    CurrentValue = false,
    Flag = "AutoCapacity",
    Callback = function(Value)
        Settings.AutoUpgradeCapacity = Value
    end,
})

UpgradeTab:CreateToggle({
    Name = "ğŸ’° Auto Upgrade Income",
    CurrentValue = false,
    Flag = "AutoIncome",
    Callback = function(Value)
        Settings.AutoUpgradeIncome = Value
    end,
})

UpgradeTab:CreateToggle({
    Name = "ğŸ”„ Auto Rebirth",
    CurrentValue = false,
    Flag = "AutoRebirth",
    Callback = function(Value)
        Settings.AutoRebirth = Value
    end,
})

UpgradeTab:CreateLabel("â”â”â” Manual â”â”â”")

UpgradeTab:CreateButton({
    Name = "âš¡ Buy Speed +1",
    Callback = function()
        UpgradeSpeed()
        Notify("Upgrade", "Bought speed!", 2)
    end,
})

UpgradeTab:CreateButton({
    Name = "ğŸ“¦ Buy Capacity +1",
    Callback = function()
        UpgradeCapacity()
        Notify("Upgrade", "Bought capacity!", 2)
    end,
})

UpgradeTab:CreateButton({
    Name = "ğŸ”„ Rebirth Now",
    Callback = function()
        DoRebirth()
    end,
})

-- PLAYER TAB
PlayerTab:CreateLabel("â”â”â” ğŸ‘¤ Player Mods â”â”â”")

PlayerTab:CreateToggle({
    Name = "ğŸƒ Walk Speed",
    CurrentValue = false,
    Flag = "WalkSpeed",
    Callback = function(Value)
        Settings.WalkSpeed = Value
        if not Value and Humanoid then
            Humanoid.WalkSpeed = 16
        end
    end,
})

PlayerTab:CreateSlider({
    Name = "Walk Speed Value",
    Range = {16, 500},
    Increment = 1,
    CurrentValue = 100,
    Flag = "WalkSpeedVal",
    Callback = function(Value)
        Settings.WalkSpeedValue = Value
    end,
})

PlayerTab:CreateToggle({
    Name = "ğŸ¦˜ Jump Power",
    CurrentValue = false,
    Flag = "JumpPower",
    Callback = function(Value)
        Settings.JumpPower = Value
        if not Value and Humanoid then
            Humanoid.JumpPower = 50
        end
    end,
})

PlayerTab:CreateSlider({
    Name = "Jump Power Value",
    Range = {50, 500},
    Increment = 10,
    CurrentValue = 100,
    Flag = "JumpPowerVal",
    Callback = function(Value)
        Settings.JumpPowerValue = Value
    end,
})

PlayerTab:CreateLabel("â”â”â” Teleports â”â”â”")

PlayerTab:CreateButton({
    Name = "ğŸ  TP to Safe Zone",
    Callback = function()
        InstantTP(SafeZone)
        Notify("TP", "Teleported!", 2)
    end,
})

PlayerTab:CreateButton({
    Name = "ğŸ  TP to Base",
    Callback = function()
        InstantTP(FindBase())
        Notify("TP", "Teleported!", 2)
    end,
})

-- VISUAL TAB
VisualTab:CreateLabel("â”â”â” ğŸ‘ï¸ ESP â”â”â”")

VisualTab:CreateToggle({
    Name = "ğŸ’ Brainrot ESP",
    CurrentValue = false,
    Flag = "ESP",
    Callback = function(Value)
        Settings.ESP = Value
        if not Value then
            ClearESP()
        end
    end,
})

VisualTab:CreateButton({
    Name = "ğŸ§¹ Clear ESP",
    Callback = function()
        ClearESP()
        Notify("ESP", "Cleared!", 2)
    end,
})

-- MISC TAB
MiscTab:CreateLabel("â”â”â” ğŸ”§ Misc â”â”â”")

MiscTab:CreateToggle({
    Name = "ğŸ’¤ Anti-AFK",
    CurrentValue = true,
    Flag = "AntiAFK",
    Callback = function(Value)
        Settings.AntiAFK = Value
    end,
})

MiscTab:CreateButton({
    Name = "ğŸ”„ Reset Character",
    Callback = function()
        if Humanoid then
            Humanoid.Health = 0
        end
    end,
})

MiscTab:CreateButton({
    Name = "ğŸ“Š Show Inventory Count",
    Callback = function()
        local count = GetInventoryCount()
        Notify("Inventory", "You have " .. count .. " brainrots", 3)
    end,
})

-- Initialize
task.spawn(function()
    wait(2)
    FindSafeZone()
    FindBase()
    
    Notify("Loaded!", "Escape Tsunami Ultimate is ready! ğŸŒŠ", 5)
    print("âœ… Script Loaded!")
    print("ğŸŒŠ Ready to farm!")
end)

-- Anti-AFK
Player.Idled:Connect(function()
    if Settings.AntiAFK then
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end
end)

-- Character respawn handler
Player.CharacterAdded:Connect(function(char)
    wait(2)
    UpdateCharacter()
    FindSafeZone()
    FindBase()
end)

print("âœ… Script Initialized Successfully!")
